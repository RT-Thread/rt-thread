import os
import sys

arguments = sys.argv[2]
vdso_usr  = os.path.dirname(arguments)
vdso_path = os.path.join(vdso_usr, '..', '..', '..')

EXEC_PATH = os.getenv('RTT_EXEC_PATH') or '/usr/bin'
PREFIX    = os.getenv('RTT_CC_PREFIX') or 'aarch64-none-elf-'

CC      = PREFIX + 'gcc'
CPP     = PREFIX + 'cpp'
AS      = PREFIX + 'gcc'
AR      = PREFIX + 'ar'
LINK    = PREFIX + 'gcc'

DEVICE  = ' -march=rv64imafdc -mabi=lp64'
AFLAGS  = ' -x assembler-with-cpp'
CFLAGS  = DEVICE + ' -Wall -Wno-cpp -std=gnu99 -fdiagnostics-color=always -fPIC -O2'
LFLAGS  = DEVICE + ' -Bsymbolic -Wl,--gc-sections -T {path}/vdso.lds'.format(path=vdso_usr)
CFLAGS += " -I . -I {vdso_path} ".format(vdso_path=vdso_path)

src = Glob('*.c')
env = Environment(tools=['gcc', 'link'],
    AS   = AS,   ASFLAGS = AFLAGS,
    CC   = CC,   CFLAGS = CFLAGS,
    CPP  = CPP,  AR   = AR,
    LINK = LINK, LINKFLAGS = LFLAGS)
env.PrependENVPath('PATH', EXEC_PATH)

target = os.path.join(vdso_path, 'user', 'build', 'libvdso.so')
shared_lib = env.SharedLibrary(target=target, source=src)
env.Default(shared_lib)
