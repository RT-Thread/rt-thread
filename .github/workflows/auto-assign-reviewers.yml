#
# Copyright (c) 2006-2025, RT-Thread Development Team
#
# SPDX-License-Identifier: Apache-2.0
#
# Change Logs:
# Date           Author       Notes
# 2025-01-21     kurisaW      Initial version
# 2025-03-14     hydevcode
# 2025-05-10     kurisaW      Fixed file existence, cache, and comment time issues

# Script Function Description: Assign PR reviews based on the MAINTAINERS list.

name: Auto Review Assistant

on:
  pull_request_target:
    branches: [ master ]
    types: [opened, synchronize, reopened]

jobs:
  assign-reviewers:
    runs-on: ubuntu-22.04
    if: github.repository_owner == 'RT-Thread' && github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      issues: read
      pull-requests: write
      contents: read
    steps:
      - name: Extract PR number
        id: extract-pr
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "PR_NUMBER=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "DEBUG: Extracted PR number: $PR_NUMBER" >&2

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: master
          sparse-checkout: MAINTAINERS
          persist-credentials: false

      - name: Verify MAINTAINERS file
        run: |
          if [[ ! -f $GITHUB_WORKSPACE/MAINTAINERS ]]; then
            echo "Error: MAINTAINERS file not found"
            exit 1
          fi
          echo "DEBUG: MAINTAINERS file verified" >&2

      - name: Get changed files
        id: changed_files
        run: |
          touch $GITHUB_WORKSPACE/changed_files.txt
          
          # Retry API call up to 3 times
          for attempt in {1..3}; do
            changed_files=$(curl -s -f \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/${{ steps.extract-pr.outputs.PR_NUMBER }}/files" | \
              jq -r '.[].filename' || echo "")
            if [[ -n "$changed_files" ]]; then
              echo "$changed_files" | grep -v '^MAINTAINERS$' > $GITHUB_WORKSPACE/changed_files.txt
              break
            fi
            echo "Attempt $attempt failed to fetch changed files, retrying..."
            sleep 2
          done
          
          if [[ -z "$changed_files" ]]; then
            echo "Error: Failed to fetch changed files after 3 attempts"
            exit 1
          fi
          
          # Get existing bot comment
          for attempt in {1..3}; do
            existing_comment=$(curl -s -f \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ steps.extract-pr.outputs.PR_NUMBER }}/comments" | \
              jq -r '.[] | select(.user.login == "github-actions[bot]") | .body | @base64' || echo "")
            if [[ -n "$existing_comment" || $attempt -eq 3 ]]; then
              break
            fi
            echo "Attempt $attempt failed to fetch comments, retrying..."
            sleep 2
          done
          
          echo "=== Changed Files ==="
          cat $GITHUB_WORKSPACE/changed_files.txt
          echo "====================="
          
          comment_time=""
          if [[ -n "$existing_comment" ]]; then
            comment_body=$(echo "$existing_comment" | base64 -d | sed -nE 's/.*Last Updated: ([0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2} UTC).*/\1/p')
            if [[ -n "$comment_body" ]]; then
              comment_time=$(date -d "$comment_body" +%s 2>/dev/null || echo "")
            fi
          fi
          echo "COMMENT_TIME=${comment_time}" >> $GITHUB_OUTPUT
          echo "DEBUG: Comment time: $comment_time" >&2

      - name: Parse MAINTAINERS file
        id: parse_maintainer
        run: |
          touch $GITHUB_WORKSPACE/tag_data.csv
          
          awk '
            /^tag:/ { 
              tag = substr($0, index($0, $2))
            }
            /^path:/ {
              path = substr($0, index($0, $2))
              gsub(/^[ \t]+|[ \t]+$/, "", path)
            }
            /^owners:/ {
              owners = substr($0, index($0, $2))
              split(owners, parts, /[()]/)
              github_ids = ""
              for (i=2; i<=length(parts); i+=2) {
                github_ids = github_ids "@" parts[i] " "
              }
              print tag "|" path "|" github_ids
            }
          ' $GITHUB_WORKSPACE/MAINTAINERS > $GITHUB_WORKSPACE/tag_data.csv
          echo "DEBUG: MAINTAINERS parsed, tag_data.csv created" >&2

      - name: Generate reviewers list
        id: generate_reviewers
        run: |
          touch $GITHUB_WORKSPACE/triggered_reviewers.txt $GITHUB_WORKSPACE/triggered_tags.txt $GITHUB_WORKSPACE/unique_reviewers.txt $GITHUB_WORKSPACE/unique_tags.txt
          
          while IFS='|' read -r tag path reviewers; do
            escaped_path=$(sed 's/[.[\*^$]/\\&/g' <<< "$path")
            if [[ "$path" == */ ]]; then
              grep -qE "^$escaped_path(/.*)?$" $GITHUB_WORKSPACE/changed_files.txt
            else
              grep -qE "^$escaped_path$" $GITHUB_WORKSPACE/changed_files.txt
            fi
            if [[ $? -eq 0 ]]; then
              echo "$reviewers" | tr -s ' ' '\n' | sed '/^$/d' >> $GITHUB_WORKSPACE/triggered_reviewers.txt
              echo "$tag" >> $GITHUB_WORKSPACE/triggered_tags.txt
              echo "DEBUG: Matched: $path â†’ $tag" >&2
            fi
          done < $GITHUB_WORKSPACE/tag_data.csv
          
          sort -u $GITHUB_WORKSPACE/triggered_reviewers.txt > $GITHUB_WORKSPACE/unique_reviewers.txt
          sort -u $GITHUB_WORKSPACE/triggered_tags.txt > $GITHUB_WORKSPACE/unique_tags.txt
          
          echo "=== Matched Paths ==="
          cat $GITHUB_WORKSPACE/triggered_tags.txt
          echo "=== Matched Reviewers ==="
          cat $GITHUB_WORKSPACE/triggered_reviewers.txt

      - name: Restore Reviewers Cache
        id: reviewers-cache-restore
        if: steps.changed_files.outputs.COMMENT_TIME != ''
        uses: actions/cache/restore@v4
        with:
          path: |
            $GITHUB_WORKSPACE/unique_tags_bak.txt
            $GITHUB_WORKSPACE/unique_reviewers_bak.txt
          key: ${{ runner.os }}-auto-assign-reviewers-${{ steps.extract-pr.outputs.PR_NUMBER }}-${{ steps.changed_files.outputs.COMMENT_TIME }}

      - name: Validate Restored Cache
        if: steps.reviewers-cache-restore.outputs.cache-hit == 'true'
        run: |
          if [[ ! -f $GITHUB_WORKSPACE/unique_reviewers_bak.txt || ! -f $GITHUB_WORKSPACE/unique_tags_bak.txt ]]; then
            echo "Error: Invalid cache data"
            exit 1
          fi
          echo "DEBUG: Cache validated" >&2

      - name: Get approval status
        id: get_approval
        run: |
          current_time=$(date -u +"%Y-%m-%d %H:%M UTC")
          touch $GITHUB_WORKSPACE/unique_reviewers.txt $GITHUB_WORKSPACE/approval_data.txt $GITHUB_WORKSPACE/review_status.md
          
          reviewers=$(cat $GITHUB_WORKSPACE/unique_reviewers.txt | tr '\n' '|' | sed 's/|$//')
          
          for attempt in {1..3}; do
            comments=$(curl -s -f \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ steps.extract-pr.outputs.PR_NUMBER }}/comments" || echo "")
            if [[ -n "$comments" || $attempt -eq 3 ]]; then
              break
            fi
            echo "Attempt $attempt failed to fetch comments, retrying..."
            sleep 2
          done
          
          if [[ -z "$comments" ]]; then
            echo "Error: Failed to fetch comments after 3 attempts"
            exit 1
          fi
          
          echo '#!/bin/bash' > $GITHUB_WORKSPACE/approval_data.sh
          echo 'declare -A approvals=()' >> $GITHUB_WORKSPACE/approval_data.sh
          
          jq -r --arg reviewers "$reviewers" '
            .[] | 
            select(.user.login != "github-actions[bot]") |
            select(.body | test("^\\s*LGTM\\s*$"; "i")) |
            .user.login as $user |
            "@\($user)" as $mention |
            select($mention | inside($reviewers)) |
            "approvals[\"\($mention)\"]=\"\(.created_at)\""
          ' <<< "$comments" >> $GITHUB_WORKSPACE/approval_data.sh
          
          jq -r --arg reviewers "$reviewers" '
            .[] | 
            select(.user.login != "github-actions[bot]") |
            select(.body | test("^\\s*LGTM\\s*$"; "i")) |
            .user.login as $user |
            "@\($user)" as $mention |
            select($mention | inside($reviewers)) |
            "\($mention) \(.created_at)"
          ' <<< "$comments" >> $GITHUB_WORKSPACE/approval_data.txt
          
          chmod +x $GITHUB_WORKSPACE/approval_data.sh
          source $GITHUB_WORKSPACE/approval_data.sh
          
          notified_users=""
          if [[ -f $GITHUB_WORKSPACE/unique_reviewers_bak.txt ]]; then
            notified_users=$(cat $GITHUB_WORKSPACE/unique_reviewers_bak.txt | xargs)
          fi
          
          {
            echo "---"
            echo "### ðŸ“Š Current Review Status (Last Updated: $current_time)"
            while read -r reviewer; do
              formatted_reviewer="${reviewer#@}"
              if [[ -n "${approvals[$reviewer]}" ]]; then
                timestamp=$(date -d "${approvals[$reviewer]}" -u +"%Y-%m-%d %H:%M UTC")
                echo "- âœ… **$formatted_reviewer** Reviewed On $timestamp"
              else
                if [[ " $notified_users " =~ " $reviewer " ]]; then
                  echo "- âŒ› **$formatted_reviewer** Pending Review"
                else
                  echo "- âŒ› **@$formatted_reviewer** Pending Review"
                fi
              fi
            done < $GITHUB_WORKSPACE/unique_reviewers.txt
          } > $GITHUB_WORKSPACE/review_status.md
          
          echo "CURRENT_TIME=${current_time}" >> $GITHUB_OUTPUT
          echo "DEBUG: Approval status generated" >&2

      - name: Generate review data
        id: generate_review
        run: |
          touch $GITHUB_WORKSPACE/review_data.md
          
          unique_tags=$(cat $GITHUB_WORKSPACE/unique_tags.txt | xargs)
          unique_tags_bak=""
          if [[ -f $GITHUB_WORKSPACE/unique_tags_bak.txt ]]; then
            unique_tags_bak=$(cat $GITHUB_WORKSPACE/unique_tags_bak.txt | xargs)
          fi
          
          existing_tags=""
          for tag in $unique_tags; do
            if [[ ! " $unique_tags_bak " =~ " $tag " ]]; then
              existing_tags+="$tag "
            fi
          done
          
          current_time=$(date -u +"%Y-%m-%d %H:%M UTC")
          {
            echo "## ðŸ“Œ Code Review Assignment"
            echo ""
            while IFS='|' read -r tag path reviewers; do
              escaped_path=$(sed 's/[.[\*^$]/\\&/g' <<< "$path")
              if [[ "$path" == */ ]]; then
                grep -qE "^$escaped_path(/.*)?$" $GITHUB_WORKSPACE/changed_files.txt
              else
                grep -qE "^$escaped_path$" $GITHUB_WORKSPACE/changed_files.txt
              fi
              if [[ $? -eq 0 ]]; then
                echo "### ðŸ·ï¸ Tag: $tag"
                echo "**Path:** \`$path\`"
                if [[ " $existing_tags " =~ " $tag " ]]; then
                  echo "**Reviewers:** $reviewers"
                else
                  formatted_reviewers=$(echo "$reviewers" | sed 's/@//g')
                  echo "**Reviewers:** $formatted_reviewers"
                fi
                echo "<details>"
                echo "<summary><b>Changed Files</b> (Click to expand)</summary>"
                echo ""
                if [[ "$path" == */ ]]; then
                  grep -E "^$escaped_path(/.*)?$" $GITHUB_WORKSPACE/changed_files.txt | sed 's/^/- /'
                else
                  grep -E "^$escaped_path$" $GITHUB_WORKSPACE/changed_files.txt | sed 's/^/- /'
                fi
                echo ""
                echo "</details>"
                echo ""
              fi
            done < $GITHUB_WORKSPACE/tag_data.csv
            cat $GITHUB_WORKSPACE/review_status.md
            echo "---"
            echo "### ðŸ“ Review Instructions"
            echo ""
            echo "1. **ç»´æŠ¤è€…å¯ä»¥é€šè¿‡å•å‡»æ­¤å¤„æ¥åˆ·æ–°å®¡æŸ¥çŠ¶æ€:** [ðŸ”„ åˆ·æ–°çŠ¶æ€](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo "   **Maintainers can refresh the review status by clicking here:** [ðŸ”„ Refresh Status](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo ""
            echo "2. **ç¡®è®¤å®¡æ ¸é€šè¿‡åŽè¯„è®º \`LGTM/lgtm\`**"
            echo "   **Comment \`LGTM/lgtm\` after confirming approval**"
            echo ""
            echo "3. **PRåˆå¹¶å‰éœ€è‡³å°‘ä¸€ä½ç»´æŠ¤è€…ç¡®è®¤**"
            echo "   **PR must be confirmed by at least one maintainer before merging**"
            echo ""
            echo "> â„¹ï¸ **åˆ·æ–°CIçŠ¶æ€æ“ä½œéœ€è¦å…·å¤‡ä»“åº“å†™å…¥æƒé™ã€‚**"
            echo "> â„¹ï¸ **Refresh CI status operation requires repository Write permission.**"
          } > $GITHUB_WORKSPACE/review_data.md
          echo "DEBUG: Review data generated" >&2

      - name: Post/Update comment
        id: post_comment
        run: |
          for attempt in {1..3}; do
            existing_comment=$(curl -s -f \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ steps.extract-pr.outputs.PR_NUMBER }}/comments" | \
              jq -r '.[] | select(.user.login == "github-actions[bot]") | {id: .id, body: .body} | @base64' || echo "")
            if [[ -n "$existing_comment" || $attempt -eq 3 ]]; then
              break
            fi
            echo "Attempt $attempt failed to fetch comments, retrying..."
            sleep 2
          done
          
          new_reviewers=$(cat $GITHUB_WORKSPACE/unique_reviewers.txt | sort | tr '\n' ' ')
          old_reviewers=""
          if [[ -f $GITHUB_WORKSPACE/unique_reviewers_bak.txt ]]; then
            old_reviewers=$(cat $GITHUB_WORKSPACE/unique_reviewers_bak.txt | sort | tr '\n' ' ')
          fi
          
          if [[ "$new_reviewers" != "$old_reviewers" && -n "$existing_comment" ]]; then
            comment_id=$(echo "$existing_comment" | base64 -d | jq -r .id)
            echo "Reviewers changed, deleting old comment $comment_id"
            curl -s -X DELETE \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/comments/$comment_id"
            existing_comment=""
          fi
          
          if [[ -n "$existing_comment" ]]; then
            comment_id=$(echo "$existing_comment" | base64 -d | jq -r .id)
            echo "Updating existing comment $comment_id"
            curl -s -X PATCH \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -d "$(jq -n --arg body "$(cat $GITHUB_WORKSPACE/review_data.md)" '{body: $body}')" \
              "https://api.github.com/repos/${{ github.repository }}/issues/comments/$comment_id"
          else
            echo "Creating new comment"
            curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -d "$(jq -n --arg body "$(cat $GITHUB_WORKSPACE/review_data.md)" '{body: $body}')" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ steps.extract-pr.outputs.PR_NUMBER }}/comments"
          fi
          echo "DEBUG: Comment posted/updated" >&2

      - name: Get Comment Time
        id: get_comment_time
        run: |
          current_time=$(date -u +"%s")
          echo "CURRENT_TIME=${current_time}" >> $GITHUB_OUTPUT
          cp $GITHUB_WORKSPACE/unique_reviewers.txt $GITHUB_WORKSPACE/unique_reviewers_bak.txt
          cp $GITHUB_WORKSPACE/unique_tags.txt $GITHUB_WORKSPACE/unique_tags_bak.txt
          echo "DEBUG: Comment time: $current_time" >&2

      - name: Save Reviewers Cache
        id: reviewers-cache-save
        uses: actions/cache/save@v4
        with:
          path: |
            $GITHUB_WORKSPACE/unique_tags_bak.txt
            $GITHUB_WORKSPACE/unique_reviewers_bak.txt
          key: ${{ runner.os }}-auto-assign-reviewers-${{ steps.extract-pr.outputs.PR_NUMBER }}-${{ steps.get_comment_time.outputs.CURRENT_TIME }}