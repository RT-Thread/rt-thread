#
# Copyright (c) 2006-2025, RT-Thread Development Team
#
# SPDX-License-Identifier: Apache-2.0
#
# Change Logs:
# Date           Author       Notes
# 2025-01-21     kurisaW      Initial version
#

# Script Function Description: Assign PR reviews based on the MAINTAINERS list.

name: Auto Review Assistant

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
  issue_comment:
    types: [created]

jobs:
  assign-reviewers:
    runs-on: ubuntu-22.04
    if: github.repository_owner == 'RT-Thread'
    permissions:
      issues: write
      pull-requests: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get changed files
        id: changed_files
        run: |
          # é€šè¿‡ GitHub API è·å– PR çš„å˜æ›´æ–‡ä»¶åˆ—è¡¨
          changed_files=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.ACTION_TOKEN_AUTO_REVIEW }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" | \
            jq -r '.[].filename')  # ä½¿ç”¨ jq æå–æ–‡ä»¶å
          
          echo "$changed_files" | grep -v '^MAINTAINERS$' > changed_files.txt

      - name: Parse MAINTAINERS file
        id: parse_maintainer
        run: |
          # ä½¿ç”¨ AWK è§£æ MAINTAINERS æ–‡ä»¶æ ¼å¼ï¼š
          # æå– tagï¼ˆæ ‡ç­¾ï¼‰ã€pathï¼ˆè·¯å¾„ï¼‰å’Œ ownersï¼ˆç»´æŠ¤è€… GitHub IDï¼‰
          awk '
            /^tag:/ { 
              tag = substr($0, index($0, $2))  # æå–æ ‡ç­¾å†…å®¹
            }
            /^path:/ { 
              path = substr($0, index($0, $2))  # æå–è·¯å¾„å†…å®¹
            }
            /^owners:/ {
              owners = substr($0, index($0, $2))  # æå–ç»´æŠ¤è€…ä¿¡æ¯
              split(owners, parts, /[()]/)       # æ‹†åˆ†å‡º GitHub IDï¼ˆæ‹¬å·å†…å†…å®¹ï¼‰
              github_ids = ""
              for (i=2; i<=length(parts); i+=2) {
                github_ids = github_ids "@" parts[i] " "  # æ‹¼æ¥ä¸º @user æ ¼å¼
              }
              print tag "|" path "|" github_ids
            }
          ' MAINTAINERS > tag_data.csv

      - name: Generate reviewers list
        id: generate_reviewers
        run: |
          # æ ¹æ®å˜æ›´æ–‡ä»¶è·¯å¾„åŒ¹é…ç»´æŠ¤è€…è§„åˆ™
          rm -f triggered_reviewers.txt
          while IFS='|' read -r tag path reviewers; do
            # ä½¿ç”¨æ­£åˆ™åŒ¹é…è·¯å¾„ï¼ˆæ”¯æŒå­ç›®å½•ï¼‰
            if grep -qE "^$path(/|$)" changed_files.txt; then
              echo "$reviewers" | tr ' ' '\n' >> triggered_reviewers.txt
            fi
          done < tag_data.csv
          # å»é‡å¤„ç†
          awk 'NF && !seen[$0]++' triggered_reviewers.txt > unique_reviewers.txt

      - name: Get approval status
        id: get_approval
        run: |
          current_time=$(date -u +"%Y-%m-%d %H:%M UTC")
          reviewers=$(cat unique_reviewers.txt | tr '\n' '|')
          
          # è·å– PR çš„æ‰€æœ‰è¯„è®º
          comments=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.ACTION_TOKEN_AUTO_REVIEW }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")

          echo '#!/bin/bash' > approval_data.sh
          echo 'declare -A approvals=()' >> approval_data.sh
          
          # ä½¿ç”¨ jq è§£æåŒ…å« LGTM çš„æœ‰æ•ˆè¯„è®º
          jq -r --arg reviewers "$reviewers" '
            .[] | 
            select(.user.login != "github-actions[bot]") |  # æ’é™¤ bot çš„è¯„è®º
            select(.body | test("^\\s*LGTM\\s*$"; "i")) |   # åŒ¹é… LGTM è¯„è®ºï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
            .user.login as $user |
            "@\($user)" as $mention |
            select($mention | inside($reviewers)) |         # è¿‡æ»¤æœ‰æ•ˆå®¡æŸ¥è€…
            "approvals[\"\($mention)\"]=\"\(.created_at)\""  # è®°å½•å®¡æ‰¹æ—¶é—´
          ' <<< "$comments" >> approval_data.sh
          
          # åŠ è½½å®¡æŸ¥æ•°æ®å¹¶ç”ŸæˆçŠ¶æ€æŠ¥å‘Š
          chmod +x approval_data.sh
          source ./approval_data.sh

          {
            echo "---"
            echo "### ğŸ“Š Current Review Status (Last Updated: $current_time)"
            while read -r reviewer; do
              if [[ -n "${approvals[$reviewer]}" ]]; then
                timestamp=$(date -d "${approvals[$reviewer]}" -u +"%Y-%m-%d %H:%M UTC")
                echo "- âœ… **$reviewer** Reviewed On $timestamp"
              else
                echo "- âŒ› **$reviewer** Pending Review"
              fi
            done < unique_reviewers.txt
          } > review_status.md

      - name: Generate review data
        id: generate_review
        run: |
          current_time=$(date -u +"%Y-%m-%d %H:%M UTC")
          {
            # ç”Ÿæˆå®¡æŸ¥åˆ†é…ä¿¡æ¯
            echo "## ğŸ“Œ Code Review Assignment"
            echo ""

            while IFS='|' read -r tag path reviewers; do
              if grep -qE "^$path(/|$)" changed_files.txt; then
                echo "### ğŸ·ï¸ Tag: $tag"
                echo "**Path:** \`$path\`  "
                echo "**Reviewers:** $reviewers  "
                echo "<details>"
                echo "<summary><b>Changed Files</b> (Click to expand)</summary>"
                echo ""
                grep -E "^$path(/|$)" changed_files.txt | sed 's/^/- /'  # åˆ—å‡ºåŒ¹é…çš„å˜æ›´æ–‡ä»¶
                echo ""
                echo "</details>"
                echo ""
              fi
            done < tag_data.csv
            # æ’å…¥å®¡æŸ¥çŠ¶æ€
            cat review_status.md

            echo "---"
            echo "### ğŸ“ Review Instructions"
            echo ""
            echo "1. **ç»´æŠ¤è€…å¯ä»¥é€šè¿‡å•å‡»æ­¤å¤„æ¥åˆ·æ–°å®¡æŸ¥çŠ¶æ€:** [ğŸ”„ åˆ·æ–°çŠ¶æ€](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo "   **Maintainers can refresh the review status by clicking here:** [ğŸ”„ Refresh Status](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo ""
            echo "2. **ç¡®è®¤å®¡æ ¸é€šè¿‡åè¯„è®º \`LGTM/lgtm\`**"
            echo "   **Comment \`LGTM/lgtm\` after confirming approval**"
            echo ""
            echo "3. **PRåˆå¹¶å‰éœ€è‡³å°‘ä¸€ä½ç»´æŠ¤è€…ç¡®è®¤**"
            echo "   **PR must be confirmed by at least one maintainer before merging**"
            echo ""
            echo "> â„¹ï¸ **åˆ·æ–°CIçŠ¶æ€æ“ä½œéœ€è¦å…·å¤‡ä»“åº“å†™å…¥æƒé™ã€‚**"
            echo "> â„¹ï¸ **Refresh CI status operation requires repository Write permission.**"
          } > review_data.md

      - name: Post/Update comment
        id: post_comment
        run: |
          # æŸ¥æ‰¾ç°æœ‰çš„ bot è¯„è®º
          existing_comment=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.ACTION_TOKEN_AUTO_REVIEW }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" | \
            jq -r '.[] | select(.user.login == "github-actions[bot]") | {id: .id, body: .body} | @base64')
          
          if [[ -n "$existing_comment" ]]; then
            # æ›´æ–°ç°æœ‰è¯„è®º
            comment_id=$(echo "$existing_comment" | head -1 | base64 -d | jq -r .id)
            echo "Updating existing comment $comment_id"
            response=$(curl -s -X PATCH \
              -H "Authorization: Bearer ${{ secrets.ACTION_TOKEN_AUTO_REVIEW }}" \
              -d "$(jq -n --arg body "$(cat review_data.md)" '{body: $body}')" \
              "https://api.github.com/repos/${{ github.repository }}/issues/comments/$comment_id")
          else
            # åˆ›å»ºæ–°è¯„è®º
            echo "Creating new comment"
            response=$(curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.ACTION_TOKEN_AUTO_REVIEW }}" \
              -d "$(jq -n --arg body "$(cat review_data.md)" '{body: $body}')" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")
          fi
