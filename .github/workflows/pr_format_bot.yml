name: PR Format Notification
on:
  pull_request_target:
    types: [opened]


concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  contents: read

jobs:
  notify-format:
    if: github.repository_owner == 'RT-Thread'
    runs-on: ubuntu-latest
    steps:
      - name: Check if first commit and add comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Event action: ${{ github.event.action }}"
          
          # è·å– PR çš„æäº¤ä¿¡æ¯
          commits=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/commits")

          # æ£€æŸ¥ API å“åº”æ˜¯å¦ä¸ºæ•°ç»„
          if echo "$commits" | jq -e 'type == "array"' > /dev/null; then
            commit_count=$(echo "$commits" | jq '. | length')
            echo "PR commit count: $commit_count"

            should_comment=false
            if [ "${{ github.event.action }}" = "opened" ]; then
              should_comment=true
            elif [ "${{ github.event.action }}" = "synchronize" ] && [ "$commit_count" -eq 1 ]; then
              should_comment=true
            fi

            if [ "$should_comment" = true ]; then
              echo "Adding format notification comment..."
              
              # æ„å»ºå·¥ä½œæµé“¾æ¥
              branch="${{ github.event.pull_request.head.ref }}"
              fork_repo="${{ github.event.pull_request.head.repo.full_name }}"
              workflow_url="https://github.com/${fork_repo}/actions/workflows/pr_clang_format.yml"
              direct_link="${workflow_url}?branch=${branch}"

              # ä½¿ç”¨æ•°ç»„å­˜å‚¨å¤šè¡Œæ¶ˆæ¯
              message_lines=(
                "<!-- PR Format Notification Comment -->"
                "**ğŸ‘‹ æ„Ÿè°¢æ‚¨å¯¹ RT-Thread çš„è´¡çŒ®ï¼Thank you for your contribution to RT-Thread!**"
                ""
                "ä¸ºç¡®ä¿ä»£ç ç¬¦åˆ RT-Thread çš„ç¼–ç è§„èŒƒï¼Œè¯·åœ¨ä½ çš„ä»“åº“ä¸­æ‰§è¡Œä»¥ä¸‹æ­¥éª¤è¿è¡Œä»£ç æ ¼å¼åŒ–å·¥ä½œæµï¼ˆå¦‚æœæ ¼å¼åŒ–CIè¿è¡Œå¤±è´¥ï¼‰ã€‚"
                "To ensure your code complies with RT-Thread's coding style, please run the code formatting workflow by following the steps below (If the formatting of CI fails to run)."
                ""
                "---"
                ""
                "### ğŸ›  æ“ä½œæ­¥éª¤ | Steps"
                ""
                "1. **å‰å¾€ Actions é¡µé¢ | Go to the Actions page**"
                "[ç‚¹å‡»è¿›å…¥å·¥ä½œæµ â†’ | Click to open workflow â†’](${direct_link})"
                ""
                "2. **ç‚¹å‡» \`Run workflow\` | Click \`Run workflow\`**"
                "- è®¾ç½®éœ€æ’é™¤çš„æ–‡ä»¶/ç›®å½•ï¼ˆç›®å½•è¯·ä»¥\"/\"ç»“å°¾ï¼‰"
                "Set files/directories to exclude (directories should end with \"/\")"
                "- å°†ç›®æ ‡åˆ†æ”¯è®¾ç½®ä¸º \ Set the target branch toï¼š**\`${branch}\`**"
                "- è®¾ç½®PR numberä¸º \ Set the PR number toï¼š**\`${{ github.event.pull_request.number }}\`**"
                ""
                "3. **ç­‰å¾…å·¥ä½œæµå®Œæˆ | Wait for the workflow to complete**"
                "æ ¼å¼åŒ–åçš„ä»£ç å°†è‡ªåŠ¨æ¨é€è‡³ä½ çš„åˆ†æ”¯ã€‚"
                "The formatted code will be automatically pushed to your branch."
                ""
                "å®Œæˆåï¼Œæäº¤å°†è‡ªåŠ¨æ›´æ–°è‡³ \`${branch}\` åˆ†æ”¯ï¼Œå…³è”çš„ Pull Request ä¹Ÿä¼šåŒæ­¥æ›´æ–°ã€‚"
                "Once completed, commits will be pushed to the \`${branch}\` branch automatically, and the related Pull Request will be updated."
                ""
                "å¦‚æœ‰é—®é¢˜æ¬¢è¿è”ç³»æˆ‘ä»¬ï¼Œå†æ¬¡æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼ğŸ’"
                "If you have any questions, feel free to reach out. Thanks again for your contribution!"
              )
              
              # æ‹¼æ¥æ•°ç»„ä¸ºå¤šè¡Œå­—ç¬¦ä¸²
              message=$(printf "%s\n" "${message_lines[@]}")

              echo "Message content:"
              echo "$message"

              # æŸ¥æ‰¾ç°æœ‰çš„ bot è¯„è®º
              existing_comment=$(curl -s \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" | \
                jq -r '.[] | select(.user.login == "github-actions[bot]" and (.body | contains("<!-- PR Format Notification Comment -->"))) | {id: .id, body: .body} | @base64')

              # ä½¿ç”¨ jq å®‰å…¨åœ°æ„å»º JSON è´Ÿè½½
              json_payload=$(jq -n --arg body "$message" '{"body": $body}')

              if [[ -n "$existing_comment" ]]; then
                # æ›´æ–°ç°æœ‰è¯„è®º
                comment_id=$(echo "$existing_comment" | head -1 | base64 -d | jq -r .id)
                echo "Updating existing comment $comment_id"
                response=$(curl -s -w "\n%{http_code}" \
                  -X PATCH \
                  -H "Accept: application/vnd.github.v3+json" \
                  -H "Authorization: Bearer $GITHUB_TOKEN" \
                  -d "$json_payload" \
                  "https://api.github.com/repos/${{ github.repository }}/issues/comments/$comment_id")
              else
                # åˆ›å»ºæ–°è¯„è®º
                echo "Creating new comment"
                response=$(curl -s -w "\n%{http_code}" \
                  -X POST \
                  -H "Accept: application/vnd.github.v3+json" \
                  -H "Authorization: Bearer $GITHUB_TOKEN" \
                  -d "$json_payload" \
                  "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")
              fi

              # æå– HTTP çŠ¶æ€ç å’Œå“åº”ä½“
              http_code=$(echo "$response" | tail -n1)
              response_body=$(echo "$response" | sed '$d')

              if [ "$http_code" -eq 201 ] || [ "$http_code" -eq 200 ]; then
                echo "Format notification comment added/updated successfully"
                echo "Comment URL: $(echo "$response_body" | jq -r '.html_url')"
              else
                echo "Failed to add/update comment. HTTP status: $http_code"
                echo "Response: $response_body"
                exit 1
              fi
            else
              echo "Not the first commit, skipping comment"
            fi
          else
            echo "Failed to get commits from GitHub API"
            echo "Response: $commits"
            exit 1
          fi